<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home | Object Recognition and Navigation for Visually Impaired Person</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* optional: mas kita ang annotated image */
    #imagePreview { max-width: 100%; border-radius: 8px; }
    .results-area ul { margin-top: .5rem; padding-left: 1.2rem; }

    /* Language switcher (minimal) */
    .lang-wrap { display:flex; align-items:center; gap:.5rem; margin-left:1rem; }
    .lang-wrap label { color:#fff; font-size:.9rem; }
    #langSelect {
      appearance:none; background:#1f2937; color:#fff;
      border:1px solid #374151; border-radius:8px;
      padding:.35rem .75rem; font-size:.9rem; cursor:pointer;
    }
    header .container { display:flex; align-items:center; justify-content:space-between; }
    header nav { display:flex; align-items:center; }
    header nav ul#navMenu { display:flex; gap:1rem; align-items:center; }
    @media (max-width: 640px) { .lang-wrap label { display:none; } }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <button class="menu-toggle"><i class="fas fa-bars"></i></button>
      <a style="color:#fff;text-decoration:none;" href="/index.html">
        <h1 data-i18n="site_title">Object Recognition and Navigation</h1>
      </a>

      <nav>
        <ul id="navMenu">
          <li><a href="/index.html" data-i18n="nav_home">Home</a></li>
          <li><a href="/information.html" data-i18n="nav_info">Object information</a></li>
          <li><a href="/loc.html" data-i18n="nav_info">Location</a></li>
        </ul>

        <!-- Language switcher -->
        <div class="lang-wrap" aria-label="Language selector">
          <i class="fas fa-globe" aria-hidden="true" style="color:#fff;"></i>
          <label for="langSelect" data-i18n="label_language">Language</label>
          <select id="langSelect" aria-label="Language">
            <option value="en">English</option>
            <option value="tl">Tagalog</option>
            <option value="ceb">Cebuano</option>
          </select>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <div class="map-wrap">
      <div class="map-head">
        <h2><i class="fas fa-location-arrow"></i> Your Location Map</h2>
      </div>
      <div id="mapStatus">Asking for your location…</div>
      <p class="status">Lat/Lon: <span id="gmCoords">--</span></p>
      <button id="enableLocationBtn" type="button">Enable location</button>
      <iframe id="gmIframe" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
  </main>

  <script>
  // Helpers
  function setStatus(msg){ const el = document.getElementById('mapStatus'); if (el) el.textContent = msg || ''; }
  function setCoords(lat, lon){ const el = document.getElementById('gmCoords'); if (el) el.textContent = (lat && lon) ? `${lat}, ${lon}` : '--'; }
  function mapsLangParam() {
    const sel = document.getElementById('langSelect');
    const v = (sel && sel.value) ? sel.value : 'en';
    // Google Maps web UI supports 'en' and 'fil' (walang 'ceb'), kaya ceb -> en
    return (v === 'tl') ? 'fil' : 'en';
  }
  function embedMap(lat, lon, acc) {
    const iframe = document.getElementById('gmIframe');
    const hl = mapsLangParam();
    iframe.src = `https://www.google.com/maps?q=${lat},${lon}&z=16&hl=${hl}&output=embed`;
    iframe.style.display = 'block';
    setStatus(`Embedded at your location (±${acc} m).`);
  }

  // Core geolocation (will trigger permission prompt)
  function requestLocationOnce() {
    return new Promise((resolve, reject) => {
      if (!('geolocation' in navigator)) return reject(new Error('Geolocation not supported.'));
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = +pos.coords.latitude.toFixed(6);
          const lon = +pos.coords.longitude.toFixed(6);
          const acc = Math.round(pos.coords.accuracy || 0);
          resolve({ lat, lon, acc });
        },
        err => reject(err),
        { enableHighAccuracy:true, timeout:10000, maximumAge:5000 }
      );
    });
  }

  async function autoAskAndEmbed() {
    // Require HTTPS (or localhost) para gumana ang geolocation
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      setStatus('Geolocation requires HTTPS (or localhost).');
      return;
    }

    // If Permissions API is available, check state for nicer UX
    try {
      if (navigator.permissions && navigator.permissions.query) {
        const p = await navigator.permissions.query({ name: 'geolocation' });
        if (p.state === 'granted') {
          const { lat, lon, acc } = await requestLocationOnce();
          setCoords(lat, lon);
          embedMap(lat, lon, acc);
          return;
        }
        if (p.state === 'denied') {
          setStatus('Location permission is blocked. Enable it in your browser settings.');
          document.getElementById('enableLocationBtn').style.display = 'inline-block';
          return;
        }
        // p.state === 'prompt' → proceed to immediate request (will show prompt)
      }
    } catch (_) { /* ignore */ }

    // Aggressive auto-prompt on first paint
    try {
      setStatus('Asking for your location…');
      const { lat, lon, acc } = await requestLocationOnce();
      setCoords(lat, lon);
      embedMap(lat, lon, acc);
    } catch (e) {
      console.warn('Geo error:', e);
      const btn = document.getElementById('enableLocationBtn');
      btn.style.display = 'inline-block';
      if (e && e.code === 1) setStatus('Permission denied by user.');
      else if (e && e.code === 2) setStatus('Position unavailable.');
      else if (e && e.code === 3) setStatus('Location request timed out.');
      else setStatus('Unable to get your location.');
    }
  }

  // Fallback button if the browser blocked auto-prompt (some Safari/iOS configs)
  document.getElementById('enableLocationBtn')?.addEventListener('click', async () => {
    try {
      setStatus('Requesting location…');
      const { lat, lon, acc } = await requestLocationOnce();
      setCoords(lat, lon);
      embedMap(lat, lon, acc);
      document.getElementById('enableLocationBtn').style.display = 'none';
    } catch (e) {
      console.warn('Geo error:', e);
      if (e && e.code === 1) setStatus('Permission denied. Please allow location.');
      else if (e && e.code === 2) setStatus('Position unavailable.');
      else if (e && e.code === 3) setStatus('Timeout. Try again.');
      else setStatus('Unable to get your location.');
    }
  });

  // Auto-request on page load (this will prompt immediately)
  document.addEventListener('DOMContentLoaded', autoAskAndEmbed);

  // Optional: kapag nagpalit ng language sa dropdown, i-refresh lang ang iframe para magbago ang map labels
  document.getElementById('langSelect')?.addEventListener('change', () => {
    const iframe = document.getElementById('gmIframe');
    if (!iframe || !iframe.src) return;
    const [lat, lon] = (document.getElementById('gmCoords')?.textContent || '').split(',').map(s=>s?.trim());
    if (lat && lon) {
      const hl = mapsLangParam();
      iframe.src = `https://www.google.com/maps?q=${lat},${lon}&z=16&hl=${hl}&output=embed`;
    }
  });
</script>


</body>
</html>